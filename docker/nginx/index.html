



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Tomas Hellström, @helto4real">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>nginx and lets encrypt</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133997912-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-133997912-1")</script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#setup-nginx-letsencrypt-for-improved-security" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="My Home Assistant docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                My Home Assistant docs
              </span>
              <span class="md-header-nav__topic">
                nginx and lets encrypt
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/helto4real/hassio/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="My Home Assistant docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    My Home Assistant docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/helto4real/hassio/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../gear/" title="My gear" class="md-nav__link">
      My gear
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../bluetooth/" title="Bluetooth tracker" class="md-nav__link">
      Bluetooth tracker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deconz/" title="Deconz" class="md-nav__link">
      Deconz
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        nginx and lets encrypt
      </label>
    
    <a href="./" title="nginx and lets encrypt" class="md-nav__link md-nav__link--active">
      nginx and lets encrypt
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hass-config" title="Hass config" class="md-nav__link">
    Hass config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linuxserverletsencrypt" title="linuxserver/letsencrypt" class="md-nav__link">
    linuxserver/letsencrypt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-nginx" title="Setup nginx" class="md-nav__link">
    Setup nginx
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ssl-certificates" title="1. SSL certificates" class="md-nav__link">
    1. SSL certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-default-server" title="2. Default server" class="md-nav__link">
    2. Default server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-hassio-server" title="3. Hassio server" class="md-nav__link">
    3. Hassio server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#router-setup" title="Router setup" class="md-nav__link">
    Router setup
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      System
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        System
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../system/1_proxmox/" title="1. Setup the system - proxmox" class="md-nav__link">
      1. Setup the system - proxmox
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../system/2_hassio/" title="2. Setup the system - Hassio" class="md-nav__link">
      2. Setup the system - Hassio
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../system/3_move_old_hassio/" title="3. Move old settings to new" class="md-nav__link">
      3. Move old settings to new
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hass-config" title="Hass config" class="md-nav__link">
    Hass config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linuxserverletsencrypt" title="linuxserver/letsencrypt" class="md-nav__link">
    linuxserver/letsencrypt
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-nginx" title="Setup nginx" class="md-nav__link">
    Setup nginx
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ssl-certificates" title="1. SSL certificates" class="md-nav__link">
    1. SSL certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-default-server" title="2. Default server" class="md-nav__link">
    2. Default server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-hassio-server" title="3. Hassio server" class="md-nav__link">
    3. Hassio server
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#router-setup" title="Router setup" class="md-nav__link">
    Router setup
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/helto4real/hassio/edit/master/docs/docker/nginx.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="setup-nginx-letsencrypt-for-improved-security">Setup nginx, letsencrypt for improved security</h1>
<p>I let you know my configuration to setup the reverse proxy (nginx) as a front with SSL for Home Assistant. My setup enables:
- Access Home Assistant with SSL from outside firewall through standard port and is routed to the home assistant on port 8123.
- Access Home Assistant from within the network (behind firewall) without SSL and using <code>http://ip:8123</code>
- In future expose more services on standard port 443 by extending nginx config</p>
<p><em>DISCLAIMER: I dont take any responsibility that this configuration is 100% secure. It is more secure than not using a reverse proxy I would argue but I am not making any guarantees. I would recommend you read how to configure this your self</em></p>
<p>Many would argue to improve security at a pro level is to use a real firewall with different v-lans for your devices and computers. This is not covered in this setup.</p>
<h2 id="hass-config">Hass config</h2>
<p>I use api password for security and <strong><em>not</em></strong> using <code>trusted_networks</code> for improved security. If you want to use <code>trusted_networks</code> I would not use a reverse proxy with <code>x_forwarded_for: True</code> config. There is a risk of hacking into hass by inserting the x_forwarded header without login!</p>
<p>I also enabled ip-ban and login attempts for even better security.</p>
<pre><code class="yaml">http:
  api_password: !secret http_password
  ip_ban_enabled: True
  login_attempts_threshold: 3
  use_x_forwarded_for: True
</code></pre>

<h2 id="linuxserverletsencrypt">linuxserver/letsencrypt</h2>
<p>Setup the linux server by using the provided docker-compose file. Mine is configured to listen to port 80/443 and I setup my routers portforwarding to point to the host, hosting this docker image. You will need the port 80 open to allow the letsecrypt to validate ownership of your domain. After that is completed and you get your certificates you can just leave the 80 closed and only forward 443 or any custom port you want to expose from the internet. Just make sure you change that in the compose-file.</p>
<p>Change the <code>domain.example</code> to your domain. If you use duckdns, use the whole address like <code>xyz.duckdns.org</code>. If you plan to expose several subdomains, use the <code>SUBDOMAINS</code> settings. At least expose the standard and <code>www</code>. But you might want to expose <code>grafana.expample.com</code>, just put <code>,grafana</code> there.</p>
<p>Copy the file and run <code>sudo docker-compose up -d</code> while on the same directory as the <code>docker-compose.yaml</code> file.</p>
<p>Check the log to make sure the certificates are created correctly.</p>
<h2 id="setup-nginx">Setup nginx</h2>
<p>First you want the ssl to configured to the correct certificates.</p>
<h3 id="1-ssl-certificates">1. SSL certificates</h3>
<p>You can see the paths in the log. The ssl config are at:
<code>/opt/letsencrypt/config/ngingx/ssl.conf</code> if you used my settings in docker-compose.yaml. Mine are in config folder (github) as reference.</p>
<pre><code class="conf"># ssl certs
ssl_certificate /etc/letsencrypt/live/domain.example/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/domain.example/privkey.pem;
</code></pre>

<h3 id="2-default-server">2. Default server</h3>
<p>Go to the folder <code>/opt/letsencrypt/config/nginx/site-confs</code> edit the <code>default</code>. See config folder here for reference.</p>
<p>All requests by default both on 80 and 443 is redirected to return 444. </p>
<pre><code class="yaml">server {
    listen 80;
    server_name _;
    return 444;
}

server {
    listen 443 ssl;
    server_name _;
    include /config/nginx/ssl.conf;
    return 444;

}
</code></pre>

<h3 id="3-hassio-server">3. Hassio server</h3>
<p>Now we make a new file in <code>/opt/letsencrypt/config/nginx/site-confs</code> called <code>hassio</code>.</p>
<p>The config is when you surf with domain.example (default 443) it routes it to your_hass_ip:8123. </p>
<pre><code class="yaml">
map $http_upgrade $connection_upgrade {
   default upgrade;
   ''      close;
}

server {
    listen       443 ssl;
    server_name  domain.example;

    include /config/nginx/ssl.conf;

    proxy_buffering off;
    location / {
        proxy_pass ip_to_hass:8123;
        proxy_set_header Host $host;
        proxy_redirect http:// https://;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location /api/websocket {
        proxy_pass ip_to_hass:8123/api/websocket;
        proxy_set_header Host $host;

        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

    }
}

</code></pre>

<h2 id="router-setup">Router setup</h2>
<p>Use your router to port forward 443 to the ip of nginx docker host. Remember to portforward port 80 to same host setting up letsecrypt. Then you can remove it once you have the domain ownership established.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deconz/" title="Deconz" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deconz
              </span>
            </div>
          </a>
        
        
          <a href="../../system/1_proxmox/" title="1. Setup the system - proxmox" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                1. Setup the system - proxmox
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>